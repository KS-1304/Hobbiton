<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kingshot World Map</title>

    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .myDivIcon {
            text-align: center;
            /* Horizontally center the text (icon) */
            line-height: 40px;
            /* Vertically center the text (icon) */
            border-radius: 100%;
            box-sizing: border-box;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
        }

        .sanctuary {
            color: grey;
        }

        .castle {
            color: gold;
        }

        .fortress {
            color: gold;
        }

        .leaflet-control-rotate {
            visibility: hidden;
        }

        .leaflet-tooltip {
            background-color: transparent;
            border: 0px;
            box-shadow: none;
        }

        .info {
            padding: 6px 8px;
            font: 16px/18px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }

        .FKN {
            border: 2px dashed white;
            background-color: orange;
        }

        .KVK {
            border: 2px dashed white;
            background-color: gold;
        }

        .LGN {
            border: 2px dashed white;
            background-color: red;
        }

        .LgN {
            border: 2px dashed white;
            background-color: pink;
        }

        .CcC {
            border: 2px dashed white;
            background-color: green;
            color: white;
        }

        .CCC {
            border: 2px dashed white;
            background-color: lightseagreen;
        }

        .HOB {
            border: 2px dashed black;
            background-color: white;
        }

        .hob {
            border: 2px dashed black;
            background-color: lightgray;
        }

        .FRA {
            border: 2px dashed white;
            background-color: lightblue;
        }

        .TMA {
            border: 2px dashed white;
            background-color: blue;
            color: white;
        }

        .LMA {
            border: 2px dashed white;
            background-color: purple;
            color: white;
        }




        .legend {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-family: Arial, sans-serif;
            max-width: 300px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-box {
            width: 30px;
            height: 20px;
        }

        .touching-glow {
            box-shadow: 0 0 12px 10px white !important;
            z-index: 1000 !important;
        }

        /* Modal styles for editing owner */
        .owner-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .owner-modal {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 300px;
            font-family: Arial, sans-serif;
        }

        .owner-modal h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .owner-modal label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .owner-modal input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }

        .owner-modal .feature-info {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #666;
        }

        .owner-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .owner-modal-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .owner-modal-buttons .cancel-btn {
            background: #e0e0e0;
            color: #333;
        }

        .owner-modal-buttons .cancel-btn:hover {
            background: #d0d0d0;
        }

        .owner-modal-buttons .save-btn {
            background: #4CAF50;
            color: white;
        }

        .owner-modal-buttons .save-btn:hover {
            background: #45a049;
        }

        .leaflet-panel-layers-list {
            height: auto !important;
            overflow-y: auto !important;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/aazuspan/leaflet-feature-legend/src/feature-legend.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/aazuspan/leaflet-feature-legend/src/feature-legend.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotate@0.2.8/dist/leaflet-rotate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-panel-layers@1.3.1/dist/leaflet-panel-layers.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet-panel-layers@1.3.1/dist/leaflet-panel-layers.min.css"
        rel="stylesheet">


</head>

<body>
    <div id="map"></div>

    <script>
        const CONFIG = {
            enableTouching: false
        };

        // set default zoom level and center point
        var coords = [600, 600];
        var zoomLevel = 0;
        var bounds = [[0, 0], [1200, 1200]];

        // Declare map & Rotate it

        var map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -1,
            rotate: true,
            rotateControl: {
                closeOnZeroBearing: false,
                // position: 'bottomleft',
            },
            bearing: -45,
            zoomControl: false

        }).setView(coords, zoomLevel);

        //L.control.zoom({ position: 'bottomleft' }).addTo(map);


        // Declare featuregroup layers, overlay map and icon > featuregroup layer.

        var armoryLayer = L.featureGroup().addTo(map);
        var arsenalLayer = L.featureGroup().addTo(map);
        var buildersLayer = L.featureGroup().addTo(map);
        var castleLayer = L.featureGroup().addTo(map);
        var drillLayer = L.featureGroup().addTo(map);
        var foragersLayer = L.featureGroup().addTo(map);
        var fortressLayer = L.featureGroup().addTo(map);
        var harvestLayer = L.featureGroup().addTo(map);
        var lodgeLayer = L.featureGroup().addTo(map);
        var sanctuaryLayer = L.featureGroup().addTo(map);
        var scholarsLayer = L.featureGroup().addTo(map);

        var baseMaps = {};

        var overlays = {
            "Armory": armoryLayer,
            "Arsenal": arsenalLayer,
            "Builder's Guild": buildersLayer,
            "Castle": castleLayer,
            "Drill Camp": drillLayer,
            "Forager's Grove": foragersLayer,
            "Fortress": fortressLayer,
            "Frontier Lodge": lodgeLayer,
            "Harvest Altar": harvestLayer,
            "Sanctuary": sanctuaryLayer,
            "Scholar's Tower": scholarsLayer
        }

        var layersmap = {
            "armory": armoryLayer,
            "arsenal": arsenalLayer,
            "builders": buildersLayer,
            "castle": castleLayer,
            "drill": drillLayer,
            "foragers": foragersLayer,
            "fortress": fortressLayer,
            "lodge": lodgeLayer,
            "harvest": harvestLayer,
            "sanctuary": sanctuaryLayer,
            "scholars": scholarsLayer
        }


        // BASE MAP DRAWING
        // Draw outer bounds.
        var polygon = L.polygon([
            [0, -0],
            [0, 1200],
            [1200, 1200],
            [1200, 0]
        ], { color: 'green' }).addTo(map);

        // Draw plains boundary
        var polygon = L.polygon([
            [300, 300],
            [300, 899],
            [899, 899],
            [899, 300]
        ], { color: 'green' }).addTo(map);

        // Draw fertile land
        var polygon = L.polygon([
            [450, 450],
            [450, 749],
            [749, 749],
            [749, 450]
        ], { color: 'greenyellow' }).addTo(map);

        // Declare helper functions for updating the info pane.
        function highlightFeature(e) {
            var layer = e.target;
            info.update(layer.feature.properties, layer.feature.geometry);
        }

        function resetHighlight(e) {
            info.update();
        }

        // Declare icon defs and mapping.

        var iconmap = {
            "armory": '<span class="mdi mdi-24px mdi-shield-cross"></span>',
            "arsenal": '<span class="mdi mdi-24px mdi-shield-sword"></span>',
            "builders": '<span class="mdi mdi-24px mdi-hard-hat"></span>',
            "castle": '<span class="mdi mdi-48px mdi-castle"></span>',
            "drill": '<span class="mdi mdi-24px mdi-train"></span>',
            "foragers": '<span class="mdi mdi-24px mdi-cart"></span>',
            "fortress": '<span class="mdi mdi-36px mdi-chess-rook"></span>',
            "lodge": '<span class="mdi mdi-24px mdi-greenhouse"></span>',
            "harvest": '<span class="mdi mdi-24px mdi-barley"></span>',
            "sanctuary": '<span class="mdi mdi-36px mdi-shield-crown"></span>',
            "scholars": '<span class="mdi mdi-24px mdi-bookshelf"></span>'
        }

        // Set-up tooltip, icon, layer group using onEachFeature

        function updateLayerDisplay(feature, layer) {
            // Update icon with new owner class
            layer.setIcon(
                L.divIcon({
                    html: iconmap[feature.properties.icon],
                    iconSize: [42, 42],
                    iconAnchor: [21, 21],
                    className: 'myDivIcon ' + feature.properties.OWNER + (CONFIG.enableTouching && feature.properties.touching ? ' touching-glow' : '')
                })
            );
            // Update tooltip with new owner
            layer.unbindTooltip();
            layer.bindTooltip(feature.properties.Type + ' L' + feature.properties.level + '</br>X:' + feature.geometry.coordinates[0] + ' Y:' + feature.geometry.coordinates[1] + '</br>Buff: ' + feature.properties.buff + '<br />Held By:' + feature.properties.OWNER);
        }

        function showOwnerEditModal(feature, layer) {
            // Create modal overlay
            var overlay = document.createElement('div');
            overlay.className = 'owner-modal-overlay';

            var modal = document.createElement('div');
            modal.className = 'owner-modal';

            modal.innerHTML = `
        <h3>Edit Owner</h3>
        <div class="feature-info">
          <strong>${feature.properties.Type}</strong> Level ${feature.properties.level}<br>
          Location: X${feature.geometry.coordinates[0]}, Y${feature.geometry.coordinates[1]}<br>
          Buff: ${feature.properties.buff}
        </div>
        <label for="owner-input">Owner:</label>
        <input type="text" id="owner-input" value="${feature.properties.OWNER}" maxlength="10" autofocus>
        
        ${CONFIG.enableTouching ? `
        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="touching-input" ${feature.properties.touching ? 'checked' : ''} style="width: auto; margin-bottom: 0;">
          <label for="touching-input" style="margin-bottom: 0;">Touching</label>
        </div>
        ` : ''}

        <div class="owner-modal-buttons">
          <button class="cancel-btn">Cancel</button>
          <button class="save-btn">Save</button>
        </div>
      `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            var input = modal.querySelector('#owner-input');
            var cancelBtn = modal.querySelector('.cancel-btn');
            var saveBtn = modal.querySelector('.save-btn');

            // Focus and select input
            setTimeout(function () {
                input.focus();
                input.select();
            }, 50);

            // Close modal function
            function closeModal() {
                document.body.removeChild(overlay);
            }

            // Save function
            function saveOwner() {
                var ownerInput = modal.querySelector('#owner-input');
                var touchingInput = modal.querySelector('#touching-input');

                var newOwner = ownerInput.value.trim();

                var changed = false;

                if (newOwner && newOwner !== feature.properties.OWNER) {
                    feature.properties.OWNER = newOwner;
                    changed = true;
                }

                if (CONFIG.enableTouching && touchingInput) {
                    var newTouching = touchingInput.checked;
                    if (newTouching !== feature.properties.touching) {
                        feature.properties.touching = newTouching;
                        changed = true;
                    }
                }

                if (changed) {
                    updateLayerDisplay(feature, layer);
                    // Update info pane if visible
                    info.update(feature.properties, feature.geometry);
                }
                closeModal();
            }

            // Event listeners
            cancelBtn.addEventListener('click', closeModal);
            saveBtn.addEventListener('click', saveOwner);

            // Close on overlay click
            overlay.addEventListener('click', function (e) {
                if (e.target === overlay) {
                    closeModal();
                }
            });

            // Handle Enter and Escape keys
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    saveOwner();
                } else if (e.key === 'Escape') {
                    closeModal();
                }
            });

            // Prevent map interactions while modal is open
            L.DomEvent.disableClickPropagation(overlay);
        }

        function onEachFeature(feature, layer) {
            // does this feature have a property named popupContent?
            if (feature.properties && feature.properties.Type) {
                layer.setIcon(
                    L.divIcon({
                        html: iconmap[feature.properties.icon],
                        iconSize: [42, 42],
                        iconAnchor: [21, 21],
                        className: 'myDivIcon ' + feature.properties.OWNER + (CONFIG.enableTouching && feature.properties.touching ? ' touching-glow' : '')
                    })
                );
                layer.bindTooltip(feature.properties.Type + ' L' + feature.properties.level + '</br>X:' + feature.geometry.coordinates[0] + ' Y:' + feature.geometry.coordinates[1] + '</br>Buff: ' + feature.properties.buff + '<br />Held By:' + feature.properties.OWNER);
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: function () {
                        showOwnerEditModal(feature, layer);
                    }
                });
                layersmap[feature.properties.icon].addLayer(layer);
            }
        }


        // Declare geojson features.

        var geojsonFeature;

        var urlParams = new URLSearchParams(window.location.search);
        var archive = urlParams.get('archive');
        var dataFile = archive ? `data-${archive}.json` : 'data.json';

        // Import features to map from external file.
        fetch(dataFile)
            .then(response => response.json())
            .then(data => {
                geojsonFeature = data;
                L.geoJSON(geojsonFeature, {
                    onEachFeature: onEachFeature
                }).addTo(map);
            })
            .catch(error => {
                console.error('Error loading GeoJSON data:', error);
                alert('Could not load map data from ' + dataFile + '. Please ensure the file exists.');
            });


        // Custom Leaflet Controls for Home and Export
        L.Control.Navigation = L.Control.extend({
            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'leaflet-control');
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.gap = '4px';
                container.style.border = 'none';
                container.style.background = 'transparent';
                container.style.width = 'auto';

                // Home Button
                var homeBtn = L.DomUtil.create('a', '', container);
                homeBtn.href = '../';
                homeBtn.title = 'Home';
                homeBtn.innerHTML = '<span class="mdi mdi-home"></span> Return Home';
                homeBtn.style.padding = '0 8px';
                homeBtn.style.height = '30px';
                homeBtn.style.lineHeight = '30px';
                homeBtn.style.display = 'flex';
                homeBtn.style.alignItems = 'center';
                homeBtn.style.gap = '6px';
                homeBtn.style.background = 'white';
                homeBtn.style.color = 'black';
                homeBtn.style.textDecoration = 'none';
                homeBtn.style.border = '1px solid #ccc';
                homeBtn.style.borderRadius = '4px';
                homeBtn.style.fontFamily = 'Arial, sans-serif';
                homeBtn.style.fontSize = '12px';
                homeBtn.style.fontWeight = 'bold';
                homeBtn.style.whiteSpace = 'nowrap';

                // Export Button
                var exportBtn = L.DomUtil.create('a', '', container);
                exportBtn.href = '#';
                exportBtn.title = 'Export GeoJSON';
                exportBtn.innerHTML = '<span class="mdi mdi-download"></span> Export GeoJSON';
                exportBtn.style.padding = '0 8px';
                exportBtn.style.height = '30px';
                exportBtn.style.lineHeight = '30px';
                exportBtn.style.display = 'flex';
                exportBtn.style.alignItems = 'center';
                exportBtn.style.gap = '6px';
                exportBtn.style.background = 'white';
                exportBtn.style.color = 'black';
                exportBtn.style.textDecoration = 'none';
                exportBtn.style.border = '1px solid #ccc';
                exportBtn.style.borderRadius = '4px';
                exportBtn.style.fontFamily = 'Arial, sans-serif';
                exportBtn.style.fontSize = '12px';
                exportBtn.style.fontWeight = 'bold';
                exportBtn.style.whiteSpace = 'nowrap';

                L.DomEvent.on(exportBtn, 'click', function (e) {
                    L.DomEvent.stopPropagation(e);
                    L.DomEvent.preventDefault(e);
                    exportGeoJSON();
                });

                return container;
            }
        });

        map.addControl(new L.Control.Navigation({ position: 'topleft' }));

        // Create legend + Layer Control
        var overLayers = [

            {
                group: "Outposts",
                collapsed: false,
                layers: [
                    {
                        name: "Armory",
                        icon: '<span class="mdi mdi-16px mdi-shield-cross">',
                        layer: armoryLayer
                    },
                    {
                        name: "Arsenal",
                        icon: '<span class="mdi mdi-shield-sword"></span>',
                        layer: arsenalLayer
                    },
                    {
                        name: "Builder's Guild",
                        icon: '<span class="mdi mdi-hard-hat"></span>',
                        layer: buildersLayer
                    },
                    {
                        name: "Drill Camp",
                        icon: '<span class="mdi mdi-train"></span>',
                        layer: drillLayer
                    },
                    {
                        name: "Forager's Grove",
                        icon: '<span class="mdi mdi-cart"></span>',
                        layer: foragersLayer
                    },
                    {
                        name: "Frontier Lodge",
                        icon: '<span class="mdi mdi-greenhouse"></span>',
                        layer: lodgeLayer
                    },
                    {
                        name: "Harvest Altar",
                        icon: '<span class="mdi mdi-barley"></span>',
                        layer: harvestLayer
                    },
                    {
                        name: "Scholar's Tower",
                        icon: '<span class="mdi mdi-bookshelf"></span>',
                        layer: scholarsLayer
                    }
                ]
            }
        ];
        map.addControl(new L.Control.PanelLayers(baseMaps, overLayers, { position: 'topleft', collapsibleGroups: true }));



        // Create Info Pane.
        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        // method that we will use to update the control based on feature properties passed
        info.update = function (props, coords, isTemp = false) {
            let content = '<h4>Outpost Details</h4>';
            if (props) {
                content += props.Type + ' L' + props.level + '</br>X' + coords.coordinates[0] + ',Y' + coords.coordinates[1] + '<br />Buff: ' + props.buff + '<br />Held By:' + props.OWNER;
            } else if (isTemp) {
                content = '<h4>Temporary Location</h4>';
                const x = coords[0];
                const y = coords[1];
                content += `Coord: X${x}, Y${y}<br><br>`;
                content += `<button onclick="copyShareLink(${x}, ${y})" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-bottom: 5px; width: 100%;">Copy Share Link</button>`;
                content += `<button onclick="clearTempMarker()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">Clear Marker</button>`;
            } else {
                content += 'Hover over an outpost or click map to drop pin';
            }
            this._div.innerHTML = content;
        };

        info.addTo(map);
        // Create legend for owners
        var legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML += '<div class="legend-item"><div class="legend-box FKN"></div>FKN</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box LGN"></div>LGN</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box CcC"></div>CcC</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box HOB"></div>HOB</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box FRA"></div>FRA</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box TMA"></div>TMA</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box CCC"></div>CCC</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box LgN"></div>LgN</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box LMA"></div>LMA</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box KVK"></div>KVK</div>'
            div.innerHTML += '<div class="legend-item"><div class="legend-box hob"></div>hob</div>'
            return div;
        };

        legend.addTo(map);

        // Export function
        function exportGeoJSON() {
            const dataStr = JSON.stringify(geojsonFeature, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = 'map_data_updated.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // TEMPORARY MARKER & SHARING LOGIC
        var tempMarker;

        function setTempMarker(x, y, updateUrl = true) {
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }

            tempMarker = L.marker([y, x], {
                icon: L.divIcon({
                    html: '<span class="mdi mdi-36px mdi-map-marker" style="color: #4CAF50; text-shadow: 0 0 10px white;"></span>',
                    iconSize: [36, 36],
                    iconAnchor: [18, 36],
                    className: 'temp-marker-icon'
                })
            }).addTo(map);

            info.update(null, [x, y], true);

            if (updateUrl) {
                const url = new URL(window.location);
                url.searchParams.set('tx', x);
                url.searchParams.set('ty', y);
                window.history.replaceState({}, '', url);
            }
        }

        function clearTempMarker() {
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
            const url = new URL(window.location);
            url.searchParams.delete('tx');
            url.searchParams.delete('ty');
            window.history.replaceState({}, '', url);
            info.update();
        }

        function copyShareLink(x, y) {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('Share link copied to clipboard!');
            });
        }

        map.on('click', function (e) {
            // Convert clicked latlng to integer coords (X, Y)
            const x = Math.round(e.latlng.lng);
            const y = Math.round(e.latlng.lat);

            // Only set if within map bounds
            if (x >= 0 && x <= 1200 && y >= 0 && y <= 1200) {
                setTempMarker(x, y);
            }
        });

        // Load from URL params on startup
        window.addEventListener('load', function () {
            const params = new URLSearchParams(window.location.search);
            const tx = params.get('tx');
            const ty = params.get('ty');
            if (tx !== null && ty !== null) {
                setTempMarker(parseInt(tx), parseInt(ty), false);
                // Pan to the marker
                map.panTo([parseInt(ty), parseInt(tx)]);
            }
        });

    </script>
</body>

</html>